// Copyright 2025 Canonical Ltd. All rights reserved.
// Licensed under the AGPLv3, see LICENCE file for details.

// Code generated by go generate; DO NOT EDIT.

package model

import (
	"context"
	"fmt"

	"github.com/canonical/sqlair"
	"github.com/juju/juju/domain/export/types/v{{ .Version }}"
)

// ExportV{{ .Version }} exports all model data for version {{ .Version }}.
func (st *State) ExportV{{ .Version }}(ctx context.Context) (*v{{ .Version }}.ModelExport, error) {
	var modelExport v{{ .Version }}.ModelExport
	var err error

	// Prepare statements first using the typed samples from the generated types package.
{{- range $i, $sn := .StructNames }}
	stmt{{ $sn }}, err := sqlair.Prepare("SELECT &{{ $sn }}.* FROM {{ index $.TableNames $i }}", v{{ $.Version }}.{{ $sn }}{})
	if err != nil {
		return nil, fmt.Errorf("preparing {{ $sn }} select statement: %w", err)
	}
{{- end }}

	db, err := st.DB(ctx)
	if err != nil {
		return nil, fmt.Errorf("getting db: %w", err)
	}

	if err := db.Txn(ctx, func(ctx context.Context, tx *sqlair.TX) error {
{{- range $i, $sn := .StructNames }}
		if err := tx.Query(ctx, stmt{{ $sn }}).GetAll(&modelExport.{{ $sn }}); err != nil && err != sqlair.ErrNoRows {
			return fmt.Errorf("querying {{ $sn }} (table {{ index $.TableNames $i }}): %w", err)
		}
{{- end }}
		return nil
	}); err != nil {
		return nil, fmt.Errorf("querying model data: %w", err)
	}

	return &modelExport, nil
}
